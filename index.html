<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P5X 防御效率计算器 (最终修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #00d4ff;
            --secondary-blue: #0099cc;
            --accent-teal: #00b3b3;
            --summer-green: #00cc88;
            --warm-yellow: #ffd700;
            --coral-pink: #ff6b6b;
            --deep-purple: #6a4c93;
            --light-bg: #f0f8ff;
            --card-bg: #f8f4ff;
            --card-bg-alt: #f0e8ff;
            --border-color: #e1d8f0;
            --text-dark: #2d3748;
            --text-light: #4a5568;
            --title-bg: #e6d9ff;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f8ff 50%, #e6fffa 100%);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                url('./samples/spine/bg.jpg') center/cover no-repeat,
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 179, 179, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 204, 136, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
        }
        
        .calculator-container {
            max-width: 1400px;
            margin: auto;
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .calculator-container {
                padding: 2rem;
            }
        }
        
        /* Header Section */
        .header-section {
            margin-bottom: 2rem;
            position: relative;
        }
        
        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .logo {
            height: 80px;
            width: auto;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.3));
        }
        
        .banner {
            max-width: 100%;
            height: auto;
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
            margin: 0 auto 2rem auto;
            display: block;
        }
        
        .title-section {
            flex-grow: 1;
            text-align: center;
            min-width: 300px;
        }
        
        .main-title-image {
            height: 80px; /* 与logo高度保持一致 */
            width: auto;
            margin: 0 auto 0.5rem auto; /* 居中显示 */
            display: block; /* 确保居中生效 */
            /* 添加发光效果 */
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: white;
            font-weight: 700;
            margin-bottom: 1rem;
            /* P5系列粗描边效果 */
            text-shadow: 
                -2px -2px 0 #000, -2px -1px 0 #000, -2px 0px 0 #000, -2px 1px 0 #000, -2px 2px 0 #000,
                -1px -2px 0 #000, -1px -1px 0 #000, -1px 0px 0 #000, -1px 1px 0 #000, -1px 2px 0 #000,
                0px -2px 0 #000, 0px -1px 0 #000, 0px 1px 0 #000, 0px 2px 0 #000,
                1px -2px 0 #000, 1px -1px 0 #000, 1px 0px 0 #000, 1px 1px 0 #000, 1px 2px 0 #000,
                2px -2px 0 #000, 2px -1px 0 #000, 2px 0px 0 #000, 2px 1px 0 #000, 2px 2px 0 #000;
        }
        
        /* Card Styling */
        .card {
            background: linear-gradient(145deg, var(--card-bg), var(--card-bg-alt));
            border-radius: 1rem;
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            box-shadow: 
                0 8px 32px rgba(0, 212, 255, 0.1),
                0 4px 16px rgba(0, 179, 179, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-teal), var(--summer-green));
        }
        
        label {
            display: block;
            color: var(--accent-teal);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select {
            width: 100%;
            background: linear-gradient(145deg, var(--card-bg), var(--card-bg-alt));
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.75rem;
            color: var(--text-dark);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        select option {
            background: var(--card-bg);
            color: var(--text-dark);
            padding: 0.5rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 
                0 0 0 3px rgba(0, 212, 255, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        
        /* Results Display */
        .result-display {
            background: linear-gradient(145deg, var(--card-bg), var(--card-bg-alt));
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.1);
        }
        
        .result-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-teal));
        }
        
        .result-display .value {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary-blue), var(--warm-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(-2px -2px 0 #000) drop-shadow(-2px -1px 0 #000) drop-shadow(-2px 0px 0 #000) drop-shadow(-2px 1px 0 #000) drop-shadow(-2px 2px 0 #000) drop-shadow(-1px -2px 0 #000) drop-shadow(-1px -1px 0 #000) drop-shadow(-1px 0px 0 #000) drop-shadow(-1px 1px 0 #000) drop-shadow(-1px 2px 0 #000) drop-shadow(0px -2px 0 #000) drop-shadow(0px -1px 0 #000) drop-shadow(0px 1px 0 #000) drop-shadow(0px 2px 0 #000) drop-shadow(1px -2px 0 #000) drop-shadow(1px -1px 0 #000) drop-shadow(1px 0px 0 #000) drop-shadow(1px 1px 0 #000) drop-shadow(1px 2px 0 #000) drop-shadow(2px -2px 0 #000) drop-shadow(2px -1px 0 #000) drop-shadow(2px 0px 0 #000) drop-shadow(2px 1px 0 #000) drop-shadow(2px 2px 0 #000);
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3));
        }
        
        .result-display .label {
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
            text-shadow: 
                -1px -1px 0 #000, -1px 0px 0 #000, -1px 1px 0 #000,
                0px -1px 0 #000, 0px 0px 0 #000, 0px 1px 0 #000,
                1px -1px 0 #000, 1px 0px 0 #000, 1px 1px 0 #000;
        }
        
        /* Team Grid */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .team-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Character Cards */
        .character-card {
            background: linear-gradient(145deg, var(--card-bg), var(--card-bg-alt));
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.1);
        }
        
        .character-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-teal));
        }
        
        .character-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 212, 255, 0.15);
        }
        
        .character-card.is-wonder {
            background: linear-gradient(145deg, #fff8e1, #fff3e0);
            border-color: var(--warm-yellow);
        }
        
        .character-card.is-wonder::before {
            background: linear-gradient(90deg, var(--warm-yellow), var(--coral-pink));
        }
        
        /* Character Avatar */
        .character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background: linear-gradient(145deg, var(--primary-blue), var(--accent-teal));
            border: 3px solid var(--border-color);
            flex-shrink: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.2);
        }
        
        .character-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(0, 212, 255, 0.3);
        }
        
        /* QR Code Section */
        .qr-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .qr-code {
            width: 120px;
            height: 120px;
            border-radius: 1rem;
            border: 3px solid var(--primary-blue);
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .qr-code:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(0, 212, 255, 0.4);
        }
        
        .qr-text {
            text-align: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            text-shadow: 
                -1px -1px 0 #000, -1px 0px 0 #000, -1px 1px 0 #000,
                0px -1px 0 #000, 0px 0px 0 #000, 0px 1px 0 #000,
                1px -1px 0 #000, 1px 0px 0 #000, 1px 1px 0 #000;
        }
        
        .qr-text p {
            margin: 0.2rem 0;
        }
        
        /* Buff List */
        .buff-list {
            margin-top: 1rem;
            border-top: 2px solid var(--border-color);
            padding-top: 1rem;
        }
        
        .character-card.is-wonder .buff-list {
            max-height: none;
            overflow-y: visible;
        }
        
        .wonder-buff-grid {
            display: grid;
            grid-template-columns: minmax(150px, 1fr) 3fr;
            gap: 1.5rem;
            align-items: start;
        }
        
        @media (max-width: 768px) {
            .wonder-buff-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .persona-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem;
        }
        
        .buff-column h3 {
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .buff-item {
            display: flex;
            align-items: center;
            background: linear-gradient(145deg, var(--card-bg), var(--card-bg-alt));
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .buff-item:hover {
            transform: translateX(4px);
            border-color: var(--primary-blue);
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.1);
        }
        
        .buff-item input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: var(--primary-blue);
            flex-shrink: 0;
        }
        
        .buff-item label {
            margin-bottom: 0;
            color: var(--text-dark);
            flex-grow: 1;
            cursor: pointer;
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
            font-weight: 500;
            min-width: 0;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .buff-item .buff-value-input {
            width: 80px;
            text-align: right;
            padding: 0.5rem;
            font-weight: bold;
            color: #1a202c;
            background: #ffffff;
            border: 2px solid var(--primary-blue);
            border-radius: 0.5rem;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .duration-display {
            width: 60px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--accent-teal);
            flex-shrink: 0;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .buff-type {
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            color: white;
            flex-shrink: 0;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
        }
        .buff-type-penetration {
            background-color: var(--accent-teal);
        }
        .buff-type-reduction {
            background-color: var(--coral-pink);
        }
        .buff-type-crit-rate {
            background-color: var(--warm-yellow);
            color: #000;
        }
        
        /* Section Title Styling */
        .card h2 {
            background: linear-gradient(145deg, var(--title-bg), #d4c4f0);
            color: white;
            padding: 1rem 1.5rem;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            border-radius: 1rem 1rem 0 0;
            text-align: center;
            font-weight: 900;
            text-shadow: 
                -2px -2px 0 #000, -2px -1px 0 #000, -2px 0px 0 #000, -2px 1px 0 #000, -2px 2px 0 #000,
                -1px -2px 0 #000, -1px -1px 0 #000, -1px 0px 0 #000, -1px 1px 0 #000, -1px 2px 0 #000,
                0px -2px 0 #000, 0px -1px 0 #000, 0px 0px 0 #000, 0px 1px 0 #000, 0px 2px 0 #000,
                1px -2px 0 #000, 1px -1px 0 #000, 1px 0px 0 #000, 1px 1px 0 #000, 1px 2px 0 #000,
                2px -2px 0 #000, 2px -1px 0 #000, 2px 0px 0 #000, 2px 1px 0 #000, 2px 2px 0 #000;
            border-bottom: 2px solid var(--border-color);
        }
        
        .card > p {
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin: 0 0 1.5rem 0;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .needed-values-display {
            background: linear-gradient(145deg, #2d1b69, #4a148c);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .needed-values-display p {
            color: #e6d9ff;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: none;
            border: none;
            padding: 0;
            font-size: 1.1rem;
            text-shadow: 
                -1px -1px 0 #000, -1px 0px 0 #000, -1px 1px 0 #000,
                0px -1px 0 #000, 0px 0px 0 #000, 0px 1px 0 #000,
                1px -1px 0 #000, 1px 0px 0 #000, 1px 1px 0 #000;
        }
        
        .needed-values {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f0f0f0;
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 0.5rem;
        }
        
        .needed-values span {
            color: #ffd700;
            font-weight: 900;
            font-size: 1.5rem;
            text-shadow: 
                -2px -2px 0 #000, -2px -1px 0 #000, -2px 0px 0 #000, -2px 1px 0 #000, -2px 2px 0 #000,
                -1px -2px 0 #000, -1px -1px 0 #000, -1px 0px 0 #000, -1px 1px 0 #000, -1px 2px 0 #000,
                0px -2px 0 #000, 0px -1px 0 #000, 0px 0px 0 #000, 0px 1px 0 #000, 0px 2px 0 #000,
                1px -2px 0 #000, 1px -1px 0 #000, 1px 0px 0 #000, 1px 1px 0 #000, 1px 2px 0 #000,
                2px -2px 0 #000, 2px -1px 0 #000, 2px 0px 0 #000, 2px 1px 0 #000, 2px 2px 0 #000;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
        }
    </style>
</head>
<body class="antialiased">

<div class="calculator-container">
    <div class="header-section">
        <div class="header-top-row">
            <div class="logo-container">
                <img src="./samples/spine/logo.png" alt="P5X Logo" class="logo">
            </div>
            <div class="title-section">
                 <img src="./samples/spine/biaoti.png" alt="P5X 防御效率计算器" class="main-title-image">
                 <p class="subtitle">配置您的队伍，计算击穿敌人防御所需的穿透与减防</p>
            </div>
            <div class="qr-section">
                <img src="./samples/spine/二维码.png" alt="B站关注二维码" class="qr-code">
                <div class="qr-text">
                    <p>关注我的B站</p>
                    <p>获取更多P5X攻略</p>
                </div>
            </div>
        </div>
        <img src="./samples/spine/banner.png" alt="Summer Event Banner" class="banner">
    </div>

    <div class="card mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label for="boss-select">Boss选择</label>
                <select id="boss-select"></select>
            </div>
            <div>
                <label for="boss-def">基础防御</label>
                <input type="number" id="boss-def" value="1280">
            </div>
            <div>
                <label for="boss-def-coeff">防御系数 (%)</label>
                <input type="number" id="boss-def-coeff" value="258.4">
            </div>
        </div>
    </div>

    <div class="card mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="result-display">
                <div id="total-penetration" class="value">0.0%</div>
                <div class="label">穿透总和</div>
            </div>
            <div class="result-display">
                <div id="total-reduction" class="value">0.0%</div>
                <div class="label">减防总和</div>
            </div>
            <div class="result-display">
                <div id="total-crit-rate" class="value text-yellow-400">0.0%</div>
                <div class="label">暴击率总和</div>
            </div>
            <div class="result-display">
                <div id="damage-increase" class="value text-green-400">0.0%</div>
                <div class="label">等效最终增伤</div>
            </div>
        </div>
        <div id="special-effects-display" class="mb-2 text-sm text-[#9ecbff]"></div>
        <div class="needed-values-display">
            <p>离防御系数为0，还需要：</p>
            <div class="needed-values">
                <span id="needed-penetration">0.0%</span> 穿透 或 <span id="needed-reduction">0.0%</span> 减防
            </div>
        </div>
    </div>

    <div class="card">
        <h2>主队配置</h2>
        <p>提示：所有默认数值基于满级技能（10级技能+5级心象）。您可以直接在文本框中修改以匹配您的实际情况。</p>
        
        <div id="wonder-container" class="mb-6"></div>
        <div id="global-buffs-container" class="mb-4 p-4 rounded-xl border border-[#ffffff22] bg-[#ffffff08]">
            <h3 class="text-lg font-semibold mb-3">全局加成</h3>
            <div id="global-buffs-list" class="buff-list"></div>
        </div>
        <div id="team-container" class="team-grid"></div>
        
        <h2>解明位</h2>
        <div id="enlightenment-container" class="team-grid"></div>
    </div>
</div>

<script>
// --- DATA FROM CSV & MD ---
const penetrationCsv = `,,,穿透,需要意识,持续时间
解明,长尾爱歌,潜能2,12,,
,,3技能,13.2,,-
辅助,岳羽由加莉,1技能,20,意识1,1
辅助,桥本麻由美,3技能（主目标）,10.8,,1
,,3级急速状态,15,,-
,,3技能（主目标）,10,意识1,1
,,3技能（群体）,5.4,,2
,,3技能（主目标）,11.4,意识6,1
,,3技能（群体）,5.6,意识6,2
辅助,池波星辉,3技能,13.7,,2
辅助,宫下美波,意识1,20,意识1,2
辅助,芦谷真咲,意识1,15,意识1,
主c,鹿野莓,心象5,7.5,,
主c,真田明彦,斗志4,12,,
主c,结城理,3技能（4层月相）,12.9,,
,,月相状态,12,,-
,,意识1,10,意识1,
,,心象5,7.5,,
主C,明智吾郎,执政官模式,21,,
,,心象5,7.5,,
,,专武0改,25,,
主C,喜多川祐介,潜能2,20,,1
,,意识6反击,30,意识6,
主C,新岛真,意识3 5种元素异常以上,30,意识3,
主C,奥村春,意识6瞄准目标,12,意识6,
主C,琴音蒙塔涅,意识6 5颗结晶追击,20,意识6,
主C,坂本龙司,意识6暴击时,35,意识3`;

const reductionCsv = `,,,减防,需要意识,持续时间
,wonder,紫刀5改,22,,,
,,咒刀6改,25,,3
,,黄刀5改,36,,2
,面具技能,拉昆达,38.8,,3
,面具技能,音律侵袭,32,,3
,面具技能,玛哈拉昆达,27.1,,3
,,毗湿奴,48,,2
,,诺伦,31.5,,2
,,亚诺希克,41.6,,2
,,年兽,10,,2
,,湿婆,45,,1
,,斯拉欧加,25,,1
辅助,宫下美波·夏日,1技能,25,意识2,3
主C,鹿野莓,意识1,30,意识1,
,,意识6,45,意识6,
辅助,夏川澪,1技能,43,,3
,,3技能（强化）,48.4,,2
,,专武0改,23.3,,2
解明,佐仓双叶,1技能（弱点）,65.7,,3
,,1技能（弱点）,80.3,意识4,3
,,1技能（弱点）,93.1,意识5,3
主C,明智吾郎,技能2,28,,2
主C,琴音蒙塔涅,意识2,40,意识2,3
辅助,野毛朋子·夏日,意识1,45,意识1,3
辅助,道玄坂琉七,0改专武（技能1）,16.7,,2
,,0改专武（技能2）,33.3,,2
,,技能3,18,,2
,,技能1,55.6,,2
,,技能2,73.9,,2
解明,多祢村理子,1技能,45.5,,2
辅助,李瑶玲,1技能,55.6,,2
辅助,加纳俊,2技能,62.4,,2
,,射击,35,,3
,,专武0改（受击）,30,,1
辅助,片山久未,重创,53.8,,1
,,highlight,32.3,,
,,核心意识,40,,2
辅助,桐条美鹤,绚烂冰华,64.6,,2
,,绚烂冰华,90.4,意识1,2
,,绚烂冰华,109,意识6,2
,,女王凝视,43,,2
,,女王凝视,43,意识1,2
,,女王凝视,45.4,意识6,2`;

const critRateCsv = `,,,暴击率,需要意识,持续时间
,基础,基础暴击率,5,,,
,我的宫殿,我的宫殿,1,,,
,状态,触电,10,,,
,wonder,反叛,15.7,,,
,wonder,革命,10.9,,,
辅助,桐条美鹤,寒霜洁,10,意识1,
解明,山岸风花,意识1,12,意识1,
辅助,宫下美波·夏日,技能3,17.2,,3
解明,长尾爱歌,意识1,12,意识1,
辅助,多祢村理子·未央,意识1,17,意识1,
辅助,坂井绫香,意识1,15,意识1,
解明,佐仓双叶,意识1,12,意识1,
主C,YUI,技能3,12,,3
主C,幻彩YUI,2技能,12.9,,2
, ,专武0改造,18.1,,2
辅助,芦谷真咲,意识6,15,意识6,`;

// --- GLOBAL VARIABLES ---
let characterDb = {};
let allBuffs = [];
let characters = [];
let enlightenmentChars = [];
let mainDpsChars = [];
let supportChars = [];

const recommendedTeams = {
    '佐原海夕·夏日': { support: ['宫下美波·夏日', '桥本麻由美'], enlightenment: '长尾爱歌' },
    '鹿野莓': { support: ['坂井绫香', '宫下美波·夏日'], enlightenment: '长尾爱歌' },
    '真田明彦': { support: ['桥本麻由美', '多祢村理子·未央'], enlightenment: '佐仓双叶' },
    '结城理': { support: ['岳羽由加莉', '多祢村理子·未央'], enlightenment: '长尾爱歌' },
    '北里基良': { support: ['夏川澪', '宫下美波'], enlightenment: '椎名悠美' },
    '须见俊也': { support: ['野毛朋子·夏日', '夏川澪'], enlightenment: '椎名悠美' },
    '喜多川祐介': { support: ['宫下美波·夏日', '芦谷真咲'], enlightenment: '佐仓双叶' },
    '新岛真': { support: ['长尾千津子', '多祢村理子·未央'], enlightenment: '长尾爱歌' },
    '奥村春': { support: ['野毛朋子·夏日', '多祢村理子·未央'], enlightenment: '长尾爱歌' },
    '琴音蒙塔涅': { support: ['宫下美波·夏日', '道玄坂琉七'], enlightenment: '长尾爱歌' },
    '坂本龙司': { support: ['加纳俊', '神山岭央'], enlightenment: '长尾爱歌' },
    '李瑶玲太平乐': { support: ['宫下美波·夏日', '夏川澪'], enlightenment: '长尾爱歌' },
    '芳泽霞': { support: ['坂井绫香', '宫下美波·夏日'], enlightenment: '长尾爱歌' },
    '新井素羽·夏日': { support: ['宫下美波', '多祢村理子·未央'], enlightenment: '长尾爱歌' },
    'YUI': { support: ['夏川澪', '宫下美波·夏日'], enlightenment: '长尾爱歌' },
    '幻彩YUI': { support: ['桐条美鹤', '宫下美波·夏日'], enlightenment: '长尾爱歌' },
    '雨宫莲': { support: ['桥本麻由美', '多祢村理子·未央'], enlightenment: '长尾爱歌' },
    '高卷杏': { support: ['多祢村理子·未央', '夏川澪'], enlightenment: '长尾爱歌' },
    '琴音蒙塔涅漫舞': { support: ['宫下美波·夏日', '多祢村理子·未央'], enlightenment: '长尾爱歌' },
};
const bosses = {
    "---模板A (1280/363.2%)---": { def: 1280, coeff: 363.2 },
    "---模板B (1280/258.4%)---": { def: 1280, coeff: 258.4 },
    "---模板C (1280/305.9%)---": { def: 1280, coeff: 305.9 },
    "---模板D (855/263.2%)---": { def: 855, coeff: 263.2 },
    "苏鲁特": { def: 821, coeff: 258.4 },
    "拉弥亚": { def: 821, coeff: 258.4 },
    "杰克灯笼": { def: 364, coeff: 258.4 },
    "韦驮天": { def: 364, coeff: 258.4 },
    "迦楼罗": { def: 364, coeff: 258.4 },
    "佳塔由": { def: 364, coeff: 258.4 },
    "荷鲁斯": { def: 364, coeff: 258.4 },
    "八咫乌": { def: 364, coeff: 258.4 },
    "座天使": { def: 1280, coeff: 258.4 },
    "大天使": { def: 1280, coeff: 258.4 },
    "魔罗": { def: 1280, coeff: 258.4 },
    "自定义": { def: 1280, coeff: 258.4 }
};

// --- DATA PARSING AND SETUP ---
function parseCsv(csvString, type) {
    const lines = csvString.trim().split('\n').slice(1);
    const data = [];
    let currentRole = '';
    let currentName = '';
    lines.forEach((line, index) => {
        const columns = line.split(',');
        let role = columns[0].trim() || currentRole;
        const name = columns[1].trim() || currentName;
        const source = columns[2].trim();
        const value = parseFloat(columns[3]);
        const consciousness = columns[4] && columns[4].trim().replace(/意识/g, '') !== '' ? columns[4].trim().replace(/意识/g, '') : '0';
        const duration = columns[5] ? columns[5].trim() : '';
        if (!role && name === 'wonder') role = 'WONDER';
        // 处理全局buff（基础、我的宫殿、状态）
        if ((name === '基础' || name === '我的宫殿' || name === '状态') && source && !isNaN(value)) {
            data.push({ id: `${type}-${index}`, role: role || '全局', name: name, source, value, consciousness, duration, type });
        } else if ((role || name === 'wonder' || role === '面具技能' || role === '启示') && source && !isNaN(value)) {
            data.push({ id: `${type}-${index}`, role: (role || 'WONDER').toUpperCase(), name: name || role, source, value, consciousness, duration, type });
        }
        currentRole = role;
        currentName = name;
    });
    return data;
}

function setupData() {
    const penetrationData = parseCsv(penetrationCsv, 'penetration');
    const reductionData = parseCsv(reductionCsv, 'reduction');
    const critRateData = parseCsv(critRateCsv, 'critRate');
    const allData = [...penetrationData, ...reductionData, ...critRateData];

         allData.forEach(item => {
         if(item.name === '明智吾郎') item.role = '辅助'; 
         // 处理全局buff（基础、我的宫殿、状态）和wonder的面具技能
         if (item.name === '基础' || item.name === '我的宫殿' || item.name === '状态') {
             if (!characterDb[item.name]) {
                 characterDb[item.name] = { role: '全局', buffs: [], imageUrl: '' };
             }
             characterDb[item.name].buffs.push(item);
         } else if (item.name === '反叛' || item.name === '革命') {
             // wonder的人格面具技能
             if (!characterDb['wonder']) {
                 characterDb['wonder'] = { role: 'WONDER', buffs: [], imageUrl: './samples/spine/Wonder.webp' };
             }
             characterDb['wonder'].buffs.push(item);
         } else if (!['启示', '面具技能'].includes(item.role)) {
             if (!characterDb[item.name]) {
                 characterDb[item.name] = { role: item.role, buffs: [], imageUrl: './samples/spine/Wonder.webp' };
             }
             characterDb[item.name].buffs.push(item);
         }
     });
     
     // 修正角色分类
     if(characterDb['富山佳代']) characterDb['富山佳代'].role = '解明';
    // 确保wonder对象存在
    if (!characterDb['wonder']) {
        characterDb['wonder'] = { 
            role: 'WONDER', 
            buffs: allData.filter(item => (item.name === 'wonder' || item.role === 'WONDER' || item.role === '面具技能') && item.name !== '反叛' && item.name !== '革命'),
            imageUrl: './samples/spine/Wonder.webp'
        };
    } else {
        // 合并wonder的buff（排除已经在上面添加的反叛和革命）
        const wonderBuffs = allData.filter(item => (item.name === 'wonder' || item.role === 'WONDER' || item.role === '面具技能') && item.name !== '反叛' && item.name !== '革命');
        // 避免重复添加
        const existingBuffIds = new Set(characterDb['wonder'].buffs.map(b => b.id));
        wonderBuffs.forEach(buff => {
            if (!existingBuffIds.has(buff.id)) {
                characterDb['wonder'].buffs.push(buff);
            }
        });
    }

    // 将 newCharacters 定义为全局变量，以便在其他函数中使用
    window.newCharacters = {
         '主C': ['佐原海夕·夏日', '李瑶玲太平乐', '芳泽霞', '新井素羽·夏日', 'YUI', '幻彩YUI', '雨宫莲', '高卷杏', '琴音蒙塔涅漫舞','坂本龙司', '北里基良', '须见俊也'],
         '辅助': ['多祢村理子·未央', '路菲尔', '摩尔加纳', '长尾千津子', '神山岭央', '野毛朋子', '黑谷清', '白鸟诚司', '藤川雪实','坂井绫香', '西森阳菜', '桐条美鹤'],
         '解明': ['椎名悠美', '富山佳代', '佐原海夕', '山岸风花']
     };
    
    const newCharacters = window.newCharacters;

    for (const [role, names] of Object.entries(newCharacters)) {
        names.forEach(name => {
            if (!characterDb[name]) {
                characterDb[name] = { role, buffs: [], imageUrl: `https://placehold.co/64x64/333/FFF?text=${name.charAt(0)}` };
            } else {
                // 确保角色的 role 属性正确设置
                characterDb[name].role = role;
            }
        });
    }

    if(characterDb['长尾爱歌']) characterDb['长尾爱歌'].imageUrl = './samples/spine/长尾爱歌.webp';
    if(characterDb['佐仓双叶']) characterDb['佐仓双叶'].imageUrl = './samples/spine/佐仓双叶.webp';
    if(characterDb['多祢村理子']) characterDb['多祢村理子'].imageUrl = './samples/spine/多祢村理子.webp';
    if(characterDb['鹿野莓']) characterDb['鹿野莓'].imageUrl = './samples/spine/鹿野莓.webp';
    if(characterDb['真田明彦']) characterDb['真田明彦'].imageUrl = './samples/spine/真田明彦.webp';
    if(characterDb['结城理']) characterDb['结城理'].imageUrl = './samples/spine/结城理.webp';
    if(characterDb['明智吾郎']) characterDb['明智吾郎'].imageUrl = './samples/spine/明智吾郎.webp';
    if(characterDb['喜多川祐介']) characterDb['喜多川祐介'].imageUrl = './samples/spine/喜多川祐介.webp';
    if(characterDb['新岛真']) characterDb['新岛真'].imageUrl = './samples/spine/新岛真.webp';
    if(characterDb['奥村春']) characterDb['奥村春'].imageUrl = './samples/spine/奥村春.webp';
    if(characterDb['琴音蒙塔涅']) characterDb['琴音蒙塔涅'].imageUrl = './samples/spine/琴音蒙塔涅.webp';
    if(characterDb['坂本龙司']) characterDb['坂本龙司'].imageUrl = './samples/spine/坂本龙司.webp';
    if(characterDb['北里基良']) characterDb['北里基良'].imageUrl = './samples/spine/北里基良.webp';
    if(characterDb['岳羽由加莉']) characterDb['岳羽由加莉'].imageUrl = './samples/spine/岳羽由加莉.webp';
    if(characterDb['桥本麻由美']) characterDb['桥本麻由美'].imageUrl = './samples/spine/桥本麻由美.webp';
    if(characterDb['池波星辉']) characterDb['池波星辉'].imageUrl = './samples/spine/池波星辉.webp';
    if(characterDb['宫下美波']) characterDb['宫下美波'].imageUrl = './samples/spine/宫下美波.webp';
    if(characterDb['芦谷真咲']) characterDb['芦谷真咲'].imageUrl = './samples/spine/芦谷真咲.webp';
    if(characterDb['富山佳代']) characterDb['富山佳代'].imageUrl = './samples/spine/富山佳代.webp';
    if(characterDb['宫下美波·夏日']) characterDb['宫下美波·夏日'].imageUrl = './samples/spine/宫下美波夏日.webp';
    if(characterDb['夏川澪']) characterDb['夏川澪'].imageUrl = './samples/spine/夏川澪.webp';
    if(characterDb['野毛朋子·夏日']) characterDb['野毛朋子·夏日'].imageUrl = './samples/spine/野毛朋子夏日.webp';
    if(characterDb['道玄坂琉七']) characterDb['道玄坂琉七'].imageUrl = './samples/spine/道玄坂琉七.webp';
    if(characterDb['李瑶玲']) characterDb['李瑶玲'].imageUrl = './samples/spine/李瑶玲.webp';
    if(characterDb['加纳俊']) characterDb['加纳俊'].imageUrl = './samples/spine/加纳俊.webp';
    if(characterDb['坂井绫香']) characterDb['坂井绫香'].imageUrl = './samples/spine/坂井绫香.webp';
         if(characterDb['佐原海夕·夏日']) characterDb['佐原海夕·夏日'].imageUrl = './samples/spine/佐原海夕夏日.webp';
     if(characterDb['佐原海夕']) characterDb['佐原海夕'].imageUrl = './samples/spine/佐原海夕.webp';
    if(characterDb['片山久未']) characterDb['片山久未'].imageUrl = './samples/spine/片山久未.webp';
    if(characterDb['李瑶玲太平乐']) characterDb['李瑶玲太平乐'].imageUrl = './samples/spine/李瑶玲太平乐.webp';
    if(characterDb['芳泽霞']) characterDb['芳泽霞'].imageUrl = './samples/spine/芳泽霞.webp';
    if(characterDb['新井素羽·夏日']) characterDb['新井素羽·夏日'].imageUrl = './samples/spine/新井素羽夏日.webp';
    if(characterDb['YUI']) characterDb['YUI'].imageUrl = './samples/spine/YUI.webp';
    if(characterDb['雨宫莲']) characterDb['雨宫莲'].imageUrl = './samples/spine/雨宫莲.webp';
    if(characterDb['高卷杏']) characterDb['高卷杏'].imageUrl = './samples/spine/高卷杏.webp';
    if(characterDb['多祢村理子·未央']) characterDb['多祢村理子·未央'].imageUrl = './samples/spine/多祢村理子未央.webp';
    if(characterDb['路菲尔']) characterDb['路菲尔'].imageUrl = './samples/spine/路菲尔.webp';
    if(characterDb['摩尔加纳']) characterDb['摩尔加纳'].imageUrl = './samples/spine/摩尔加纳.webp';
    if(characterDb['长尾千津子']) characterDb['长尾千津子'].imageUrl = './samples/spine/长尾千津子.webp';
    if(characterDb['神山岭央']) characterDb['神山岭央'].imageUrl = './samples/spine/神山岭央.webp';
    if(characterDb['椎名悠美']) characterDb['椎名悠美'].imageUrl = './samples/spine/椎名悠美.webp';
    if(characterDb['琴音蒙塔涅漫舞']) characterDb['琴音蒙塔涅漫舞'].imageUrl = './samples/spine/琴音蒙塔涅漫舞.webp';
    if(characterDb['野毛朋子']) characterDb['野毛朋子'].imageUrl = './samples/spine/野毛朋子.webp';
    if(characterDb['黑谷清']) characterDb['黑谷清'].imageUrl = './samples/spine/黑谷清.webp';
    if(characterDb['须见俊也']) characterDb['须见俊也'].imageUrl = './samples/spine/须见俊也.webp';
    if(characterDb['白鸟诚司']) characterDb['白鸟诚司'].imageUrl = './samples/spine/白鸟诚司.webp';
    if(characterDb['藤川雪实']) characterDb['藤川雪实'].imageUrl = './samples/spine/藤川雪实.webp';
    if(characterDb['西森阳菜']) characterDb['西森阳菜'].imageUrl = './samples/spine/西森阳菜.webp';
    if(characterDb['桐条美鹤']) characterDb['桐条美鹤'].imageUrl = './samples/spine/桐条美鹤.webp';
    if(characterDb['山岸风花']) characterDb['山岸风花'].imageUrl = './samples/spine/山岸风花.webp';
    if(characterDb['幻彩YUI']) characterDb['幻彩YUI'].imageUrl = './samples/spine/幻彩YUI.webp';

    characters = Object.keys(characterDb).sort();
    enlightenmentChars = characters.filter(name => characterDb[name].role === '解明').sort();
    mainDpsChars = characters.filter(name => characterDb[name].role === '主C').sort();
    supportChars = characters.filter(name => characterDb[name].role === '辅助' && name !== 'wonder').sort();

    const hopeDuty = { id: 'rev-hope', role: '启示', name: '职责希望', source: '职责希望', value: 5, consciousness: '0', duration: '1', type: 'penetration' };
    if (characterDb['长尾爱歌']) characterDb['长尾爱歌'].buffs.push(hopeDuty);
    if (characterDb['多祢村理子']) characterDb['多祢村理子'].buffs.push(hopeDuty);
    if (characterDb['山岸风花']) characterDb['山岸风花'].buffs.push(hopeDuty);

    const resolveDuty = { id: 'rev-resolve', role: '启示', name: '职责决心', source: '职责决心', value: 10, consciousness: '0', duration: '2', type: 'reduction' };
    if (characterDb['佐仓双叶']) characterDb['佐仓双叶'].buffs.push(resolveDuty);

         const sovereignDeparture = { id: 'rev-sovereign', role: '启示', name: '主权启程', source: '主权启程', value: 23, consciousness: '0', duration: '2', type: 'reduction' };
     
     // 只有辅助角色才获得启程主权buff
     supportChars.forEach(name => {
         if (characterDb[name] && characterDb[name].role === '辅助') {
             characterDb[name].buffs.push(sovereignDeparture);
         }
     });
    
    allBuffs = [];
    Object.values(characterDb).forEach(char => allBuffs.push(...char.buffs));
    allBuffs = [...new Set(allBuffs)];
}


// --- UI CREATION ---
function createCharacterSlots() {
    const wonderContainer = document.getElementById('wonder-container');
    const teamContainer = document.getElementById('team-container');
    const enlightenmentContainer = document.getElementById('enlightenment-container');
    const globalBuffsContainer = document.getElementById('global-buffs-list');
    
    wonderContainer.innerHTML = '';
    teamContainer.innerHTML = '';
    enlightenmentContainer.innerHTML = '';
    if (globalBuffsContainer) globalBuffsContainer.innerHTML = '';
    
    wonderContainer.appendChild(createCharacterCard(1, 'wonder'));
    teamContainer.appendChild(createCharacterCard(2, 'mainDps'));
    teamContainer.appendChild(createCharacterCard(3, 'support'));
    teamContainer.appendChild(createCharacterCard(4, 'support'));
    enlightenmentContainer.appendChild(createCharacterCard(5, 'enlightenment'));
    
    // 创建全局buff区域
    if (globalBuffsContainer) {
        createGlobalBuffs();
    }
    
    // 注意：不在这里调用updateFuukaExtraSlot，因为此时角色选择可能还没有设置
    // 将在初始化完成后根据用户的选择来创建额外槽位
}

// 创建全局buff区域
function createGlobalBuffs() {
    const globalBuffsContainer = document.getElementById('global-buffs-list');
    if (!globalBuffsContainer) return;
    
    // 基础暴击率
    if (characterDb['基础'] && characterDb['基础'].buffs.length > 0) {
        characterDb['基础'].buffs.forEach(buff => {
            if (buff.type === 'critRate') {
                const buffItem = createBuffItem(buff, false, true);
                globalBuffsContainer.appendChild(buffItem);
            }
        });
    }
    
    // 我的宫殿
    if (characterDb['我的宫殿'] && characterDb['我的宫殿'].buffs.length > 0) {
        characterDb['我的宫殿'].buffs.forEach(buff => {
            if (buff.type === 'critRate') {
                const buffItem = createBuffItem(buff, false, true);
                globalBuffsContainer.appendChild(buffItem);
            }
        });
    }
    
    // 状态（触电）
    if (characterDb['状态'] && characterDb['状态'].buffs.length > 0) {
        characterDb['状态'].buffs.forEach(buff => {
            if (buff.type === 'critRate') {
                const buffItem = createBuffItem(buff, false, true);
                globalBuffsContainer.appendChild(buffItem);
            }
        });
    }
}

function createCharacterCard(id, roleType) {
    const card = document.createElement('div');
    card.className = `character-card`;
    card.dataset.cardId = id;
    if (roleType === 'wonder') {
        card.classList.add('is-wonder');
    }

    let charSelectorHTML = '';
    let consciousnessHTML = '';
    let extraHTML = '';
    
    if (roleType === 'wonder') {
        charSelectorHTML = `
            <div class="char-selector-wrapper flex-grow">
                <label>角色选择</label>
                <select id="char-select-${id}" class="char-select" data-card-id="${id}" disabled><option value="wonder">wonder (上城渚)</option></select>
            </div>`;
    } else {
        let charList;
        if (roleType === 'mainDps') charList = mainDpsChars;
        else if (roleType === 'support') charList = supportChars;
        else if (roleType === 'enlightenment') charList = enlightenmentChars;
        else if (roleType === 'fuukaExtra') {
            // 山岸风花的额外槽位可以选择所有非解明角色（主C + 辅助）
            charList = [...mainDpsChars, ...supportChars].sort();
        }

        const charOptions = ['无', ...charList].map(name => `<option value="${name}">${name}</option>`).join('');
        let labelText = '角色选择';
        if (roleType === 'mainDps') labelText = 'C位选择';
        else if (roleType === 'support') labelText = '辅助选择';
        else if (roleType === 'enlightenment') labelText = '解明选择';
        else if (roleType === 'fuukaExtra') labelText = '风花支援角色';
        
        charSelectorHTML = `
            <div class="char-selector-wrapper">
                <label>${labelText}</label>
                <select id="char-select-${id}" class="char-select" data-card-id="${id}">${charOptions}</select>
            </div>`;
        consciousnessHTML = `
            <div class="consciousness-wrapper">
                <label>意识</label>
                <select id="consciousness-select-${id}" class="consciousness-select" data-card-id="${id}">${Array.from({length: 7}, (_, i) => `<option value="${i}">${i}</option>`).join('')}</select>
            </div>`;
    }

    // 主C、解明位和辅助位都需要穿透输入框
    // 主C位和解明位还需要暴击率输入框
    if (roleType === 'mainDps' || roleType === 'enlightenment' || roleType === 'support' || roleType === 'fuukaExtra') {
        let penetrationLabelText = '启示穿透(%)';
        if (roleType === 'support' || roleType === 'fuukaExtra') {
            penetrationLabelText = '支援穿透(%)';
        }
        extraHTML = `
            <div class="penetration-wrapper">
                <label>${penetrationLabelText}</label>
                <input type="number" id="manual-penetration-${id}" class="manual-penetration" value="0" min="0">
            </div>`;
        
        // 主C位和解明位添加暴击率输入框
        if (roleType === 'mainDps' || roleType === 'enlightenment') {
            extraHTML += `
            <div class="crit-rate-wrapper">
                <label>启示暴击(%)</label>
                <input type="number" id="manual-crit-rate-${id}" class="manual-crit-rate" value="0" min="0">
            </div>`;
        }
    }

    const hasExtra = (roleType === 'mainDps' || roleType === 'enlightenment' || roleType === 'support' || roleType === 'fuukaExtra');
    // 主C位和解明位有穿透和暴击两个输入框，所以需要4列
    const hasCritRate = (roleType === 'mainDps' || roleType === 'enlightenment');
    const gridColsClass = hasCritRate ? 'md:grid-cols-4' : (hasExtra ? 'md:grid-cols-3' : 'md:grid-cols-2');

    const topRowHTML = (roleType === 'wonder') ? `
        <div class="flex items-end gap-4">
            <img id="avatar-${id}" class="character-avatar" src="https://placehold.co/64x64/333/555?text=?" alt="avatar">
            ${charSelectorHTML}
        </div>
    ` : `
        <div class="flex items-end gap-4">
            <img id="avatar-${id}" class="character-avatar" src="https://placehold.co/64x64/333/555?text=?" alt="avatar">
            <div class="grid grid-cols-1 ${gridColsClass} gap-2 flex-grow">
                ${charSelectorHTML}
                ${consciousnessHTML}
                ${extraHTML}
            </div>
        </div>
    `;

    // 只有解明角色才显示fuuka-panel（但现在不再需要，因为用额外槽位代替）
    // 保留panel结构但默认隐藏，以备将来可能需要
    card.innerHTML = `
        ${topRowHTML}
        <div id="fuuka-panel-${id}" class="mt-3 p-3 rounded-xl border border-[#ffffff22] bg-[#ffffff08] hidden" style="display: none;">
        </div>
        <div id="buff-list-${id}" class="buff-list"></div>
    `;

    return card;
}

function updateCharacterAvatar(cardId) {
    const charName = document.getElementById(`char-select-${cardId}`).value;
    const avatarImg = document.getElementById(`avatar-${cardId}`);
    if (charName !== '无' && characterDb[charName] && characterDb[charName].imageUrl) {
        avatarImg.src = characterDb[charName].imageUrl;
    } else {
        avatarImg.src = 'https://placehold.co/64x64/333/555?text=?';
    }
}

function loadRecommendedTeam(mainCName) {
    if (!recommendedTeams[mainCName]) return;
    
    const team = recommendedTeams[mainCName];
    
    if (team.support && team.support.length > 0) {
        if (team.support[0]) {
            const support1Select = document.getElementById('char-select-3');
            if (support1Select) {
                support1Select.value = team.support[0];
                populateBuffs(3);
                updateCharacterAvatar(3);
                setSovereignDepartureCheckbox(3);
            }
        }
        
        if (team.support[1]) {
            const support2Select = document.getElementById('char-select-4');
            if (support2Select) {
                support2Select.value = team.support[1];
                populateBuffs(4);
                updateCharacterAvatar(4);
                setSovereignDepartureCheckbox(4);
            }
        }
    }
    
    if (team.enlightenment) {
        const enlightenmentSelect = document.getElementById('char-select-5');
        if (enlightenmentSelect) {
            enlightenmentSelect.value = team.enlightenment;
            populateBuffs(5);
            updateCharacterAvatar(5);
        }
    }
    
    calculateTotals();
}

 function setSovereignDepartureCheckbox(cardId) {
     const charName = document.getElementById(`char-select-${cardId}`).value;
     const buffList = document.getElementById(`buff-list-${cardId}`);
     
     if (buffList) {
         const sovereignCheckbox = buffList.querySelector('input[data-buff-id*="rev-sovereign"]');
         if (sovereignCheckbox) {
             // 只有特定角色默认勾选启程主权
             const defaultCheckedRoles = ['加纳俊', '长尾千津子', '宫下美波·夏日'];
             sovereignCheckbox.checked = defaultCheckedRoles.includes(charName);
         }
     }
 }

function populateBuffs(cardId) {
    const charName = document.getElementById(`char-select-${cardId}`).value;
    const consciousnessSelect = document.getElementById(`consciousness-select-${cardId}`);
    const consciousnessLevel = consciousnessSelect ? parseInt(consciousnessSelect.value) : 99;
    const buffListContainer = document.getElementById(`buff-list-${cardId}`);
    if (!buffListContainer) {
        console.error(`populateBuffs: buffListContainer not found for cardId ${cardId}`);
        return;
    }
    buffListContainer.innerHTML = '';
    
    if (charName === '无' || !characterDb[charName]) {
        if (charName !== '无') {
            console.warn(`populateBuffs: character "${charName}" not found in characterDb for cardId ${cardId}`);
        }
        return;
    }

    const availableBuffs = [...characterDb[charName].buffs]
        .filter(buff => consciousnessLevel >= parseInt(buff.consciousness))
        .sort((a, b) => a.source.localeCompare(b.source));
    // 山岸风花的额外槽位（cardId=6）直接显示选择角色的buff，不需要特殊处理
    // 原来的fuuka-panel逻辑已移除，改为使用额外的角色槽位
    // extraBuffs 不再需要，因为额外槽位已经是独立的角色卡片
    
    if (charName === 'wonder') {
        buffListContainer.className = 'buff-list wonder-buff-grid';
        const weaponsCol = document.createElement('div');
        weaponsCol.className = 'buff-column';
        weaponsCol.innerHTML = '<h3>武器 (减防)</h3>';
        const weaponGrid = document.createElement('div');
        weaponGrid.className = 'persona-grid';
        weaponsCol.appendChild(weaponGrid);
        
        const personasCol = document.createElement('div');
        personasCol.className = 'buff-column';
        personasCol.innerHTML = '<h3>人格面具</h3>';
        const personaGrid = document.createElement('div');
        personaGrid.className = 'persona-grid';
        personasCol.appendChild(personaGrid);
        
        // 分离不同类型的buff
        const reductionBuffs = availableBuffs.filter(b => b.type === 'reduction');
        const critRateBuffs = availableBuffs.filter(b => b.type === 'critRate');
        const penetrationBuffs = availableBuffs.filter(b => b.type === 'penetration');

        // 减防buff：武器和人格面具
        dedupeBySkill(reductionBuffs, consciousnessLevel).forEach(buff => {
            const isWeapon = buff.source.includes('刀');
            const targetCol = isWeapon ? weaponGrid : personaGrid;
            const buffItem = createBuffItem(buff, isWeapon, false);
            targetCol.appendChild(buffItem);
        });
        
        // 暴击率buff添加到人格面具列
        dedupeBySkill(critRateBuffs, consciousnessLevel).forEach(buff => {
            const buffItem = createBuffItem(buff, false, false);
            personaGrid.appendChild(buffItem);
        });
        
        // 穿透buff也添加到人格面具列（如果有）
        dedupeBySkill(penetrationBuffs, consciousnessLevel).forEach(buff => {
            const buffItem = createBuffItem(buff, false, false);
            personaGrid.appendChild(buffItem);
        });

        buffListContainer.appendChild(weaponsCol);
        buffListContainer.appendChild(personasCol);

    } else {
        buffListContainer.className = 'buff-list';
        dedupeBySkill(availableBuffs, consciousnessLevel).forEach(buff => {
            const buffItem = createBuffItem(buff, false, true);
            buffListContainer.appendChild(buffItem);
        });
    }
}

function createBuffItem(buff, isWeapon, isChecked = true) {
    let buffTypeLabel = '';
    let buffTypeClass = '';
    if (buff.type === 'penetration') {
        buffTypeLabel = '穿透';
        buffTypeClass = 'buff-type-penetration';
    } else if (buff.type === 'reduction') {
        buffTypeLabel = '减防';
        buffTypeClass = 'buff-type-reduction';
    } else if (buff.type === 'critRate') {
        buffTypeLabel = '暴击';
        buffTypeClass = 'buff-type-crit-rate';
    }
    
    const buffItem = document.createElement('div');
    buffItem.className = 'buff-item';
    const weaponClass = isWeapon ? 'weapon-checkbox' : '';
    let checkedAttr = isChecked ? 'checked' : '';
    if (buff.source === '主权启程') {
       checkedAttr = '';
    }
    // 全局buff（基础暴击率、我的宫殿、触电）默认勾选
    if (buff.source === '基础暴击率' || buff.source === '我的宫殿' || buff.source === '触电') {
        checkedAttr = 'checked';
    }
    
    const durationText = (buff.duration && buff.duration !== '' && !isNaN(buff.duration)) ? `${buff.duration}回合` : '永续';
    
    buffItem.innerHTML = `
        <input type="checkbox" id="buff-${buff.id}" data-buff-id="${buff.id}" class="buff-checkbox ${weaponClass}" ${checkedAttr}>
        <span class="buff-type ${buffTypeClass}">${buffTypeLabel}</span>
        <label for="buff-${buff.id}" title="${buff.source}">${buff.source}</label>
        <input type="number" class="buff-value-input" value="${buff.value.toFixed(1)}" step="0.1">
        <span class="duration-display">${durationText}</span>
    `;
    return buffItem;
}

function setupBossSelector() {
    const select = document.getElementById('boss-select');
    let html = '';
    Object.keys(bosses).forEach(name => {
        html += `<option value="${name}">${name}</option>`;
    });
    select.innerHTML = html;
    select.addEventListener('change', (e) => {
        const bossName = e.target.value;
        if (bosses[bossName]) {
            document.getElementById('boss-def').value = bosses[bossName].def;
            document.getElementById('boss-def-coeff').value = bosses[bossName].coeff;
        }
        calculateTotals();
    });
}


// 更新山岸风花的额外角色槽位
function updateFuukaExtraSlot() {
    const enlightenmentSelect = document.getElementById('char-select-5');
    if (!enlightenmentSelect) {
        console.warn('updateFuukaExtraSlot: enlightenment select not found');
        return;
    }
    
    const selectedChar = enlightenmentSelect.value;
    const teamContainer = document.getElementById('team-container');
    if (!teamContainer) {
        console.warn('updateFuukaExtraSlot: team-container not found');
        return;
    }
    
    // 检查是否已经存在额外的槽位（cardId=6）
    const existingExtraSlot = document.querySelector('.character-card[data-card-id="6"]');
    
    if (selectedChar === '山岸风花') {
        // 如果选择了山岸风花，添加额外的角色槽位
        if (!existingExtraSlot) {
            // 确保角色列表已经初始化
            if (!mainDpsChars || !supportChars) {
                console.error('updateFuukaExtraSlot: mainDpsChars or supportChars not initialized');
                return;
            }
            
            const extraCard = createCharacterCard(6, 'fuukaExtra');
            teamContainer.appendChild(extraCard);
            
            // 设置默认角色为"宫下美波·夏日"
            const charSelect6 = document.getElementById('char-select-6');
            if (charSelect6) {
                charSelect6.value = '宫下美波·夏日';
                // 触发change事件以确保相关函数被调用
                charSelect6.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            // 设置默认支援穿透为20
            const penetrationInput6 = document.getElementById('manual-penetration-6');
            if (penetrationInput6) {
                penetrationInput6.value = '20';
            }
            
            // 初始化新创建的卡片（如果上面的事件没有触发，这里作为备用）
            populateBuffs(6);
            updateCharacterAvatar(6);
            setSovereignDepartureCheckbox(6);
            // 触发计算
            calculateTotals();
        }
    } else {
        // 如果取消选择山岸风花或选择其他角色，移除额外的槽位
        if (existingExtraSlot) {
            existingExtraSlot.remove();
            // 重新计算总数
            calculateTotals();
        }
    }
}


function dedupeBySkill(buffList, consciousnessLevel) {
    // key by source+name+type; keep the entry with the highest consciousness <= current
    const best = new Map();
    buffList.forEach(b => {
        const need = parseInt(b.consciousness || '0');
        if (need > consciousnessLevel) return; // skip if not available at current level
        const key = `${b.source || ''}|${b.name || ''}|${b.type || ''}`;
        const prev = best.get(key);
        if (!prev) {
            best.set(key, b);
        } else {
            const prevNeed = parseInt(prev.consciousness || '0');
            // Prefer higher need; tie-breaker by higher value
            if (need > prevNeed) best.set(key, b);
            else if (need === prevNeed) {
                const v1 = parseFloat(prev.value || '0');
                const v2 = parseFloat(b.value || '0');
                if (v2 > v1) best.set(key, b);
            }
        }
    });
    return Array.from(best.values());
}

// --- EVENT HANDLING ---
function addEventListeners() {
    document.body.addEventListener('change', (e) => {
        if (e.target.matches('input, select')) {
            if (e.target.classList.contains('char-select') || e.target.classList.contains('consciousness-select')) {
                const cardId = e.target.dataset.cardId;
                const charName = e.target.classList.contains('char-select') ? e.target.value : document.getElementById(`char-select-${cardId}`).value;
                // 移除详细的日志输出，减少控制台噪音
                // console.log(`Character selection changed: cardId=${cardId}, charName=${charName}`);
                
                // 如果解明角色选择变化，更新山岸风花的额外槽位
                if (e.target.classList.contains('char-select') && cardId === '5') {
                    updateFuukaExtraSlot();
                }
                
                populateBuffs(cardId);
                updateCharacterAvatar(cardId);
                
                                 if (cardId === '2' && e.target.value !== '无') {
                     loadRecommendedTeam(e.target.value);
                 }
                 
                 // 设置启程主权的勾选状态（包括额外的槽位）
                 if ((cardId >= 3 && cardId <= 5) || cardId === '6') {
                     setSovereignDepartureCheckbox(cardId);
                 }
            }
             if (e.target.classList.contains('weapon-checkbox') && e.target.checked) {
                const weaponContainer = e.target.closest('.buff-column');
                weaponContainer.querySelectorAll('.weapon-checkbox').forEach(otherCheckbox => {
                    if (otherCheckbox !== e.target) otherCheckbox.checked = false;
                });
            }
            calculateTotals();
        }
    });

    document.body.addEventListener('input', (e) => {
        if (e.target.matches('input[type="number"]')) {
            calculateTotals();
        }
    });
}

// --- CALCULATION LOGIC ---
function calculateTotals() {
    let totalPenetration = 0;
    let totalReduction = 0;
    let totalCritRate = 0;
    let mitsuruBonus = 0; // 桐条美鹤技能加成
    let fuukaBonus = 0;   // 山岸风花技能加成

    // 1) 只统计 穿透/减防（不在这里统计暴击率，避免双算）
    document.querySelectorAll('.buff-checkbox:checked').forEach(checkbox => {
        const buffId = checkbox.dataset.buffId;
        const buff = allBuffs.find(b => b.id === buffId);
        if (buff) {
            const value = parseFloat(checkbox.closest('.buff-item').querySelector('.buff-value-input').value) || 0;
            if (buff.type === 'penetration') totalPenetration += value;
            else if (buff.type === 'reduction') totalReduction += value;
            // 注意：不累加 critRate，暴击率在第5步单独算
        }
    });

    // 2) 手动输入的穿透（主C/解明/辅助/风花支援）
    let mainCPenetration = 0;
    let supportPenetrationTotal = 0;
    let enlightenmentPenetration = 0;
    document.querySelectorAll('.manual-penetration').forEach(input => {
        const cardId = input.id.replace('manual-penetration-', '');
        const value = parseFloat(input.value) || 0;
        if (cardId === '2') { mainCPenetration = value; totalPenetration += value; }
        else if (cardId === '5') { enlightenmentPenetration = value; totalPenetration += value; }
       // else if (cardId === '3' || cardId === '4' || cardId === '6') { supportPenetrationTotal += value; totalPenetration += value; }
    });

    // 3) 美鹤“冰之舞刺击”：解明启示穿透*12%
    for (let i = 3; i <= 6; i++) {
        const sel = document.getElementById(`char-select-${i}`);
        if (sel && sel.value === '桐条美鹤') {
            mitsuruBonus = enlightenmentPenetration * 0.03 * 5;
            if (mitsuruBonus > 0) totalPenetration += mitsuruBonus;
            break;
        }
    }

    // 4) 风花“深清”：辅助总穿透*4.5%（包含风花额外槽 cardId=6）
    const enlightenmentSelect = document.getElementById('char-select-5');
    const enlightenmentChar = enlightenmentSelect ? enlightenmentSelect.value : '';
    if (enlightenmentChar === '山岸风花') {
        const carryInput = document.getElementById('manual-penetration-6');
        const carryPen   = carryInput ? (parseFloat(carryInput.value) || 0) : 0;
        fuukaBonus = carryPen * 0.045;
        if (fuukaBonus > 0) totalPenetration += fuukaBonus;
    }

    // 5) 只在这里统计 暴击率
    // 5.1 全局（基础/我的宫殿/状态）
    const globalBuffsList = document.getElementById('global-buffs-list');
    if (globalBuffsList) {
        globalBuffsList.querySelectorAll('.buff-checkbox:checked').forEach(checkbox => {
            const buff = allBuffs.find(b => b.id === checkbox.dataset.buffId);
            if (buff && buff.type === 'critRate') {
                const v = parseFloat(checkbox.closest('.buff-item').querySelector('.buff-value-input').value) || buff.value;
                totalCritRate += v;
            }
        });
    }
    // 5.2 wonder（反叛/革命）
    if (characterDb['wonder']) {
        const wonderCrits = characterDb['wonder'].buffs.filter(b => b.type === 'critRate');
        wonderCrits.forEach(buff => {
            const checkbox = document.querySelector(`.buff-checkbox[data-buff-id="${buff.id}"]`);
            if (checkbox && checkbox.checked) {
                const v = parseFloat(checkbox.closest('.buff-item').querySelector('.buff-value-input').value) || buff.value;
                totalCritRate += v;
            }
        });
    }
    // 5.3 角色暴击（按意识过滤）
    for (let i = 1; i <= 6; i++) {
        const charSelect = document.getElementById(`char-select-${i}`);
        const conSelect  = document.getElementById(`consciousness-select-${i}`);
        if (!charSelect || !conSelect) continue;
        const charName = charSelect.value;
        const conLv = parseInt(conSelect.value) || 0;
        if (charName && charName !== '无' && characterDb[charName]) {
            const crits = characterDb[charName].buffs.filter(b => b.type === 'critRate' && conLv >= parseInt(b.consciousness || '0'));
            crits.forEach(buff => {
                const checkbox = document.querySelector(`.buff-checkbox[data-buff-id="${buff.id}"]`);
                if (checkbox && checkbox.checked) {
                    const v = parseFloat(checkbox.closest('.buff-item').querySelector('.buff-value-input').value) || buff.value;
                    totalCritRate += v;
                }
            });
        }
    }
    // 5.4 主C/解明的手动暴击
    document.querySelectorAll('.manual-crit-rate').forEach(input => {
        totalCritRate += (parseFloat(input.value) || 0);
    });

    // 6) 更新 UI
    document.getElementById('total-penetration').textContent = `${totalPenetration.toFixed(1)}%`;
    document.getElementById('total-reduction').textContent   = `${totalReduction.toFixed(1)}%`;
    document.getElementById('total-crit-rate').textContent   = `${totalCritRate.toFixed(1)}%`;

    // 7) 特效提示
    updateSpecialEffectsUI(mitsuruBonus, fuukaBonus);

    // 8) 需求值
    calculateNeededValues(totalPenetration, totalReduction);
}

// 更新特殊技能加成显示
function updateSpecialEffectsUI(mitsuruBonus, fuukaBonus) {
    const displayEl = document.getElementById('special-effects-display');
    if (!displayEl) return;
    
    const effects = [];
    if (mitsuruBonus > 0) {
        effects.push(`冰之舞刺击 +${mitsuruBonus.toFixed(2)}%`);
    }
    if (fuukaBonus > 0) {
        effects.push(`深清 +${fuukaBonus.toFixed(2)}%`);
    }
    
    if (effects.length > 0) {
        displayEl.textContent = `特殊技能加成：${effects.join('，')}`;
        displayEl.style.display = 'block';
    } else {
        displayEl.textContent = '';
        displayEl.style.display = 'none';
    }
}

function calculateNeededValues(penetration, reduction) {
    const baseCoeff = parseFloat(document.getElementById('boss-def-coeff').value) / 100;
    const currentPen = penetration / 100;
    const currentRed = reduction / 100;
    const finalCoeff = (baseCoeff * (1 - currentPen)) - currentRed;

    let damageIncrease = 0;
    if (finalCoeff <= 0) {
        damageIncrease = baseCoeff * 100;
    } else {
        damageIncrease = ((1 + baseCoeff) / (1 + finalCoeff) - 1) * 100;
    }
    document.getElementById('damage-increase').textContent = `${damageIncrease.toFixed(1)}%`;

    if (finalCoeff <= 0) {
        document.getElementById('needed-penetration').textContent = '0.0%';
        document.getElementById('needed-reduction').textContent = '0.0%';
        return;
    }

    const neededReduction = finalCoeff * 100;
    const neededPenetration = (finalCoeff / baseCoeff) * 100;

    document.getElementById('needed-penetration').textContent = `${neededPenetration > 0 ? neededPenetration.toFixed(1) : '0.0'}%`;
    document.getElementById('needed-reduction').textContent = `${neededReduction > 0 ? neededReduction.toFixed(1) : '0.0'}%`;
}

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    setupData();
    setupBossSelector();
    createCharacterSlots();
    addEventListeners();
    
    document.querySelectorAll('.character-card').forEach(card => {
        const cardId = card.dataset.cardId;
        populateBuffs(cardId);
        updateCharacterAvatar(cardId);
    });
    
    // 检查是否需要创建山岸风花的额外槽位
    updateFuukaExtraSlot();

         const mainCSelect = document.getElementById('char-select-2');
     if (mainCSelect) {
         mainCSelect.value = '佐原海夕·夏日';
         populateBuffs(2);
         updateCharacterAvatar(2);
         loadRecommendedTeam('佐原海夕·夏日');
     }
     
     // 初始化时设置所有角色的启程主权状态（包括可能存在的额外槽位）
     for (let i = 1; i <= 6; i++) {
         const charSelect = document.getElementById(`char-select-${i}`);
         if (charSelect && i !== 2) { // 跳过C位，因为还没有选择角色
             setSovereignDepartureCheckbox(i);
         }
     }
     
     calculateTotals();
    
    addLoadingAnimations();
});

function addLoadingAnimations() {
    const elements = document.querySelectorAll('.card, .character-card');
    elements.forEach((el, index) => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        setTimeout(() => {
            el.style.transition = 'all 0.6s ease';
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
        }, index * 100);
    });
}
</script>
</body>
</html>